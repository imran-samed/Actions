name: Secret / API-Key Scan

on:
  pull_request:
    branches: [ main, master ]
  push:
    branches: [ main, master ]

jobs:
  scan-secrets:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Gitleaks scan
        id: gitleaks
        uses: zricethezav/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          args: detect --source . --config .github/gitleaks.toml --redact --exit-code 1 --report-format json --report-path gitleaks-report.json

      - name: Upload Gitleaks report as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-report
          path: gitleaks-report.json

      - name: Comment on PR if secrets are found
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const reportPath = 'gitleaks-report.json';

            if (!fs.existsSync(reportPath)) {
              core.warning("No gitleaks-report.json found â€” skipping comment.");
              return;
            }

            const report = JSON.parse(fs.readFileSync(reportPath, 'utf8'));
            if (!report || report.length === 0) {
              core.info("No secrets detected.");
              return;
            }

            let body = `ðŸš¨ **Gitleaks detected potential secrets!** ðŸš¨\n\n`;
            body += `**Files and keys found:**\n`;

            report.slice(0, 10).forEach((r, i) => {
              body += `${i + 1}. \`${r.File}\` â€” **${r.RuleID}** at line ${r.StartLine}\n`;
            });

            if (report.length > 10) {
              body += `\nâ€¦and ${report.length - 10} more potential leaks.`;
            }

            body += `\n\nPlease check and rotate any exposed credentials as needed. ðŸ”’`;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });
